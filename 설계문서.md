# Zota - 상세 설계 문서

## 1. 개요

Obsidian Vault와 연동하는 macOS 네이티브 앱(Swift + SwiftUI).
로컬 LLM(Ollama)을 활용하여 빠른 메모 캡처와 데일리 리뷰 자동 생성을 수행한다.

### 결정사항

| 항목 | 선택 | 이유 |
|------|------|------|
| 앱 형태 | macOS 네이티브 (Swift + SwiftUI) | Obsidian 독립 동작, 백그라운드 처리, 네이티브 UX |
| LLM 런타임 | Ollama (로컬) | 데이터 주권 보장, 오프라인 동작, 비용 없음 |
| 기본 모델 | llama3 8B (q4_k_m) | Apple Silicon 16~32GB 환경에서 성능/속도 최적 |
| Vault 연동 | 로컬 파일 시스템 직접 읽기/쓰기 | Obsidian Vault = 마크다운 폴더, 별도 API 불필요 |
| 프롬프트 관리 | Vault 내 별도 마크다운 파일 | 앱 업데이트 없이 프롬프트 개선 가능 |
| 환각 방지 | JSON 모드 + 허용값 제약 + 사용자 확인 | 초기에는 반자동으로 신뢰도 확보 |
| 최소 지원 | macOS 14 (Sonoma)+ | SwiftUI 최신 기능 활용 |

---

## 2. 전체 아키텍처

```
[Zota 앱 (SwiftUI)]
 ├── 캡처 뷰 ────────── 빠른 메모 입력 UI
 │   └── 입력 → 마크다운 파일 생성 → Vault/Inbox/
 │
 ├── 데일리 리뷰 뷰 ─── 오늘 메모 요약 UI
 │   ├── Vault/Daily/{날짜}.md 에서 메모 수집
 │   ├── Ollama API → 주제별 그룹화 + 요약
 │   └── 결과를 데일리 노트에 기록
 │
 └── 설정 뷰 ────────── Vault 경로, 모델 선택 등
        │
        ▼
[서비스 계층]
 ├── VaultService ────── 파일 읽기/쓰기, Frontmatter 파싱
 ├── OllamaService ──── REST API 통신 (localhost:11434)
 └── PromptService ──── Vault 내 프롬프트 파일 로딩/관리
        │
        ▼
[외부 의존]
 ├── Obsidian Vault (로컬 마크다운 폴더)
 └── Ollama (로컬 LLM 서버)
```

---

## 3. 프로젝트 구조

### 3.1 Xcode 프로젝트

```
Zota/
├── Zota.xcodeproj
├── Zota/
│   ├── ZotaApp.swift                # 앱 진입점
│   ├── ContentView.swift            # 메인 뷰 (탭 or 사이드바)
│   │
│   ├── Views/
│   │   ├── CaptureView.swift        # 빠른 캡처 입력 화면
│   │   ├── DailyReviewView.swift    # 데일리 리뷰 화면
│   │   └── SettingsView.swift       # 설정 화면
│   │
│   ├── Services/
│   │   ├── VaultService.swift       # Vault 파일 읽기/쓰기
│   │   ├── OllamaService.swift      # Ollama REST API 클라이언트
│   │   └── PromptService.swift      # 프롬프트 파일 로딩
│   │
│   ├── Models/
│   │   ├── Note.swift               # 노트 모델 (frontmatter + body)
│   │   ├── DailyReview.swift        # 리뷰 결과 모델
│   │   └── AppSettings.swift        # 앱 설정 모델
│   │
│   ├── Utilities/
│   │   ├── MarkdownParser.swift     # 마크다운 + YAML frontmatter 파싱
│   │   └── DateFormatter+Ext.swift  # 날짜 포맷 유틸
│   │
│   └── Resources/
│       └── Assets.xcassets
│
├── ZotaTests/
│   ├── VaultServiceTests.swift
│   ├── OllamaServiceTests.swift
│   ├── MarkdownParserTests.swift
│   └── PromptServiceTests.swift
│
└── prompts/                         # 기본 프롬프트 (Vault에 복사)
    ├── DailySummary.md
    └── Tagger.md
```

### 3.2 Vault 내 Zota 관련 구조

```
Vault/
├── Inbox/                           # 캡처된 메모가 저장되는 폴더
├── Daily/                           # 데일리 노트 (YYYY-MM-DD.md)
└── System/
    └── Prompts/                     # LLM 프롬프트 파일
        ├── DailySummary.md
        └── Tagger.md
```

### 3.3 개발 리포지토리 (claude-lab 하위)

```
obsidian-llm-automation/
├── CLAUDE.md
├── 설계문서.md                      # 이 문서
├── 진행상황.md
├── Zota/                            # Xcode 프로젝트
│   ├── Zota.xcodeproj
│   ├── Zota/                        # 소스 코드
│   └── ZotaTests/                   # 테스트
└── prompts/                         # 기본 프롬프트 파일
    ├── DailySummary.md
    └── Tagger.md
```

---

## 4. 핵심 모듈 설계

### 4.1 OllamaService

Ollama REST API와 통신하는 서비스.

```swift
// Services/OllamaService.swift
class OllamaService {
    let baseURL: URL  // 기본값: http://localhost:11434
    let model: String // 기본값: "llama3"

    /// Ollama에 프롬프트를 보내고 JSON 응답을 받는다
    func generate<T: Decodable>(
        prompt: String,
        system: String = "",
        responseType: T.Type
    ) async throws -> T {
        let request = OllamaRequest(
            model: model,
            system: system,
            prompt: prompt,
            stream: false,
            format: "json"
        )

        var urlRequest = URLRequest(url: baseURL.appendingPathComponent("/api/generate"))
        urlRequest.httpMethod = "POST"
        urlRequest.setValue("application/json", forHTTPHeaderField: "Content-Type")
        urlRequest.httpBody = try JSONEncoder().encode(request)
        urlRequest.timeoutInterval = 30

        let (data, _) = try await URLSession.shared.data(for: urlRequest)
        let ollamaResponse = try JSONDecoder().decode(OllamaResponse.self, from: data)

        // Ollama의 response 필드(문자열)를 다시 JSON 디코딩
        guard let responseData = ollamaResponse.response.data(using: .utf8) else {
            throw ZotaError.invalidResponse
        }
        return try JSONDecoder().decode(T.self, from: responseData)
    }

    /// Ollama 서버 연결 상태 확인
    func healthCheck() async -> Bool {
        do {
            let (_, response) = try await URLSession.shared.data(from: baseURL)
            return (response as? HTTPURLResponse)?.statusCode == 200
        } catch {
            return false
        }
    }
}
```

**설계 결정:**
- Swift `async/await` 사용 - SwiftUI와 자연스럽게 통합
- `Decodable` 제네릭 - 응답 타입을 호출부에서 지정, 타입 안전성 확보
- `stream: false` - 전체 응답 완성 후 처리
- `format: "json"` - JSON 출력 강제로 파싱 안정성 확보

### 4.2 VaultService

Obsidian Vault 폴더를 직접 읽고 쓰는 서비스.

```swift
// Services/VaultService.swift
class VaultService {
    let vaultPath: URL  // 사용자가 설정한 Vault 경로

    /// Inbox 폴더에 새 노트 생성
    func createNote(title: String, content: String, tags: [String] = []) throws -> URL {
        let date = Date().formatted(.iso8601.year().month().day())
        let slug = title.slugified()
        let filename = "\(date)-\(slug).md"

        let frontmatter = """
        ---
        title: "\(title)"
        date: \(date)
        tags: [\(tags.map { "\"\($0)\"" }.joined(separator: ", "))]
        ---
        """

        let fullContent = "\(frontmatter)\n\n\(content)\n"
        let filePath = vaultPath
            .appendingPathComponent("Inbox")
            .appendingPathComponent(filename)

        try fullContent.write(to: filePath, atomically: true, encoding: .utf8)
        return filePath
    }

    /// 데일리 노트 읽기
    func readDailyNote(for date: Date) throws -> Note? {
        let dateString = date.formatted(.iso8601.year().month().day())
        let path = vaultPath
            .appendingPathComponent("Daily")
            .appendingPathComponent("\(dateString).md")

        guard FileManager.default.fileExists(atPath: path.path) else { return nil }
        let content = try String(contentsOf: path, encoding: .utf8)
        return MarkdownParser.parse(content: content, path: path)
    }

    /// 데일리 노트에 리뷰 섹션 추가/교체
    func updateDailyReview(for date: Date, reviewContent: String) throws {
        guard var note = try readDailyNote(for: date) else {
            throw ZotaError.dailyNoteNotFound
        }

        if let range = note.body.range(of: "## Daily Review[\\s\\S]*?(?=\\n## |$)",
                                        options: .regularExpression) {
            note.body.replaceSubrange(range, with: reviewContent)
        } else {
            note.body.append("\n\n\(reviewContent)")
        }

        try note.fullContent.write(to: note.path, atomically: true, encoding: .utf8)
    }

    /// 오늘 데일리 노트에서 메모 항목들 추출
    func extractMemos(from date: Date) throws -> [String] {
        guard let note = try readDailyNote(for: date) else { return [] }

        // "## Memos" 섹션 아래의 리스트 항목들 추출
        guard let range = note.body.range(of: "## Memos\\n([\\s\\S]*?)(?=\\n## |$)",
                                           options: .regularExpression) else {
            return []
        }

        let memosSection = String(note.body[range])
        return memosSection
            .components(separatedBy: "\n")
            .filter { $0.hasPrefix("- ") }
            .map { String($0.dropFirst(2)) }
    }
}
```

### 4.3 PromptService

Vault 내 프롬프트 파일을 로딩하는 서비스.

```swift
// Services/PromptService.swift
class PromptService {
    let vaultPath: URL

    /// 프롬프트 파일 로딩
    func loadPrompt(named name: String) throws -> String {
        let path = vaultPath
            .appendingPathComponent("System/Prompts")
            .appendingPathComponent("\(name).md")

        guard FileManager.default.fileExists(atPath: path.path) else {
            throw ZotaError.promptNotFound(name)
        }
        return try String(contentsOf: path, encoding: .utf8)
    }
}
```

### 4.4 Models

```swift
// Models/Note.swift
struct Note {
    var frontmatter: [String: Any]
    var body: String
    var path: URL

    var fullContent: String {
        // frontmatter + body를 마크다운 문자열로 결합
        let yaml = frontmatter.toYAML()
        return "---\n\(yaml)\n---\n\n\(body)"
    }
}

// Models/DailyReview.swift
struct DailyReviewResult: Decodable {
    let achievements: [String]  // 오늘의 성과
    let ideas: [String]         // 아이디어
    let todos: [String]         // 할 일
    let summary: String         // 한줄 요약
}

// Models/AppSettings.swift
struct AppSettings: Codable {
    var vaultPath: String = ""
    var ollamaURL: String = "http://localhost:11434"
    var ollamaModel: String = "llama3"
}
```

---

## 5. UI 설계

### 5.1 앱 구조

사이드바 네비게이션 기반의 3개 화면:

```
┌──────────────────────────────────────────┐
│ Zota                                     │
├────────────┬─────────────────────────────┤
│            │                             │
│  📥 캡처   │   [선택된 화면 내용]          │
│            │                             │
│  📋 리뷰   │                             │
│            │                             │
│  ⚙️ 설정   │                             │
│            │                             │
└────────────┴─────────────────────────────┘
```

### 5.2 캡처 뷰 (CaptureView)

```
┌─────────────────────────────────┐
│ 빠른 캡처                        │
│                                 │
│ 제목: [________________________] │
│                                 │
│ 내용:                           │
│ ┌─────────────────────────────┐ │
│ │                             │ │
│ │  (텍스트 에디터)              │ │
│ │                             │ │
│ └─────────────────────────────┘ │
│                                 │
│ 태그: [개발] [학습] [+추가]      │
│                                 │
│              [저장] (⌘+Return)  │
│                                 │
│ ✅ Inbox/2026-02-07-제목.md 저장 │
└─────────────────────────────────┘
```

- 제목 필드에 포커스된 상태로 시작
- `⌘+Return`으로 빠른 저장
- 저장 후 필드 초기화 + 성공 알림
- 태그는 미리 정의된 목록에서 선택 (칩 UI)

### 5.3 데일리 리뷰 뷰 (DailyReviewView)

```
┌─────────────────────────────────┐
│ 데일리 리뷰       2026-02-07 ◀▶ │
│                                 │
│ 📝 오늘의 메모 (5건)             │
│ ┌─────────────────────────────┐ │
│ │ - 회의에서 나온 아이디어       │ │
│ │ - Swift async/await 정리     │ │
│ │ - 점심 메뉴 추천받기          │ │
│ │ - PR 리뷰 피드백 반영         │ │
│ │ - 주간 회고 작성              │ │
│ └─────────────────────────────┘ │
│                                 │
│        [🤖 AI 리뷰 생성]        │
│                                 │
│ ── AI 생성 결과 ──               │
│                                 │
│ ### 오늘의 성과                   │
│ - PR 리뷰 피드백 반영 완료        │
│ - Swift async/await 학습         │
│                                 │
│ ### 아이디어                     │
│ - 회의에서 나온 신규 기능 제안     │
│                                 │
│ ### 할 일                        │
│ - [ ] 주간 회고 작성              │
│                                 │
│ > 한줄 요약: 코드 리뷰와 학습...  │
│                                 │
│    [데일리 노트에 저장]           │
└─────────────────────────────────┘
```

- 날짜 선택으로 과거 데일리 노트도 처리 가능
- AI 생성 결과를 미리보기로 보여준 후 사용자가 확인하고 저장
- 저장 시 데일리 노트의 `## Daily Review` 섹션에 기록

### 5.4 설정 뷰 (SettingsView)

```
┌─────────────────────────────────┐
│ 설정                            │
│                                 │
│ Vault 경로                      │
│ [/Users/.../MyVault    ] [선택] │
│                                 │
│ Ollama                          │
│ URL: [http://localhost:11434  ] │
│ 모델: [llama3          ▼]      │
│ 상태: 🟢 연결됨                  │
│                                 │
│ 태그 목록                        │
│ [개발, 디자인, 업무, 학습, ...]   │
│ [편집]                           │
└──────────────────────���──────────┘
```

- Vault 경로: 폴더 선택 다이얼로그 (`NSOpenPanel`)
- Ollama 상태: 실시간 헬스 체크 표시
- 모델 목록: Ollama API (`/api/tags`)에서 설치된 모델 조회

---

## 6. 데일리 요약 프롬프트 (`prompts/DailySummary.md`)

```markdown
You are a personal assistant that organizes daily memos.

Given a list of memo items from today, organize them into these categories:
- **achievements**: Things completed or progress made
- **ideas**: New ideas, insights, or things to explore
- **todos**: Action items or tasks to do

Also provide a one-sentence summary of the day in Korean.

Output strictly in JSON format:
{
  "achievements": ["achievement 1", "achievement 2"],
  "ideas": ["idea 1"],
  "todos": ["todo 1", "todo 2"],
  "summary": "한국어로 오늘 하루 한줄 요약"
}

Example:
Input:
- PR 리뷰 완료
- SwiftUI NavigationStack 학습
- 내일 팀 미팅 준비 필요
- 점심에 좋은 카페 발견

Output: {"achievements": ["PR 리뷰 완료", "SwiftUI NavigationStack 학습"], "ideas": ["새로 발견한 카페 정보 정리"], "todos": ["내일 팀 미팅 준비"], "summary": "코드 리뷰와 SwiftUI 학습을 진행하고, 내일 미팅을 준비해야 하는 하루"}
```

---

## 7. 환경 요구사항

### 7.1 하드웨어

| 항목 | 최소 | 권장 |
|------|------|------|
| Mac | Apple Silicon M1, 8GB | M1 Pro+, 16GB+ |

### 7.2 소프트웨어

| 소프트웨어 | 버전 | 용도 |
|-----------|------|------|
| macOS | 14 (Sonoma)+ | 앱 실행 |
| Xcode | 15+ | 개발/빌드 |
| Ollama | 최신 | 로컬 LLM 런타임 |
| Obsidian | 아무 버전 | Vault 관리 (Zota와 독립적) |

---

## 8. 구축 순서

### Phase 1: 기반 구축 ✅
- Xcode 프로젝트 생성 (Zota, SwiftUI, macOS)
- 앱 기본 구조 (사이드바 네비게이션 + 3개 뷰 스켈레톤)
- `AppSettings` 모델 + `SettingsView` (Vault 경로 선택)
- `OllamaService.healthCheck()` + 설정 화면에 연결 상태 표시

### Phase 2: 빠른 캡처 ✅
- `MarkdownParser` - YAML frontmatter 파싱/생성
- `VaultService.createNote()` - Inbox 폴더에 마크다운 파일 생성
- `CaptureView` - 제목, 내용, 태그 입력 UI + FlowLayout 태그 칩
- `⌘+Return` 단축키 저장
- XCTest: VaultService(8), MarkdownParser(8), OllamaService(3) - 총 19개 통과

### Phase 3: 데일리 리뷰 ✅
- `PromptService` - Vault 내 프롬프트 파일 로딩 (없으면 기본 프롬프트 폴백)
- `DailyReviewResult` 모델 - JSON 디코딩 + `toMarkdown()` 변환
- `DailyReviewView` - 날짜 선택 → 메모 로딩 → AI 리뷰 생성 → 미리보기 → 저장
- 기본 프롬프트 파일 (`prompts/DailySummary.md`)
- XCTest: PromptService(3), DailyReview(6) - 총 28개 통과

### Phase 4: 프롬프트 최적화 ✅
- DailySummary 프롬프트: Few-Shot 3개 예시, 구체적 분류 기준, 한국어 출력 강제
- Tagger 프롬프트: 제목+내용 기반 태그 제안, 허용 목록 필터링
- CaptureView에 AI 태그 제안 버튼 (sparkles 아이콘)
- TagSuggestionResult 모델 + filteredTags 안전 필터링
- XCTest: TagSuggestion(5) - 총 33개 통과

### Phase 5: 추가 고도화 (추후)
- 인박스 자동 분류 (FSEvents로 Vault 감시 → LLM 분류 → 폴더 이동)
- 글로벌 단축키 (앱이 백그라운드일 때도 캡처 가능)
- 재무 데이터 파이프라인

---

## 9. 테스트 전략

### 9.1 단위 테스트 (XCTest)

| 테스트 대상 | 테스트 내용 |
|------------|-----------|
| `MarkdownParser` | YAML frontmatter 파싱, 생성, 빈 파일 처리 |
| `VaultService` | 노트 생성, 데일리 노트 읽기, 메모 추출, 리뷰 업데이트 |
| `OllamaService` | API 호출 (URLProtocol mock), JSON 디코딩, 타임아웃, 헬스 체크 |
| `PromptService` | 프롬프트 로딩, 파일 없을 때 에러 |

### 9.2 수동 테스트

- 실제 Vault에서 캡처 → Inbox에 파일 생성 확인
- 데일리 노트에 메모 작성 → AI 리뷰 생성 → 저장 확인
- Ollama 서버 꺼진 상태에서 적절한 에러 표시 확인

---

## 10. 위험 요소 및 대응

| 위험 | 영향 | 대응 |
|------|------|------|
| LLM 환각 (엉뚱한 분류) | 잘못된 요약/할일 생성 | 미리보기 후 사용자 확인 방식 |
| Ollama 응답 느림 | UX 저하 | ProgressView 표시 + 타임아웃 + 소형 모델 대안 |
| Vault 경로 권한 | 파일 접근 불가 | 앱 샌드박스 설정 + 폴더 접근 권한 요청 |
| 한국어 처리 품질 | 요약 정확도 | Few-Shot 예시 강화 + 한국어 특화 모델 |
| Frontmatter 파싱 엣지케이스 | 노트 깨짐 | 정규식 대신 YAML 파서 라이브러리 검토 |
